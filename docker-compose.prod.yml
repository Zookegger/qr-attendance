services:
    mysql:
        image: mysql:8.0
        container_name: qr_attendance_mysql
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-123456789}
            MYSQL_DATABASE: ${DB_NAME:-qr_attendance_prod}
            MYSQL_USER: ${DB_USER:-user}
            MYSQL_PASSWORD: ${DB_PASSWORD:-123456789}
        ports:
            - "3306:3306"
        volumes:
            - mysql_data:/var/lib/mysql
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
            timeout: 5s
            retries: 10

    redis:
        image: redis:alpine
        container_name: qr_attendance_redis
        restart: always
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            timeout: 5s
            retries: 10

    server:
        build:
            context: ./server
            dockerfile: Dockerfile
        container_name: qr_attendance_server_prod
        restart: always
        ports:
            - "5000:5000"
        environment:
            - PORT=5000
            - NODE_ENV=production
            - DB_HOST=mysql
            - DB_PORT=3306
            - DB_USER=root
            - DB_PASS=${DB_PASSWORD:-123456789}
            - DB_NAME=${DB_NAME:-qr_attendance_prod}
            - DB_DIALECT=mysql
            - REDIS_HOST=redis
            - REDIS_PORT=6379
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_healthy

    adminer:
        image: adminer
        container_name: qr_attendance_adminer
        restart: always
        ports:
            - "8080:8080"
        depends_on:
            - mysql

volumes:
    mysql_data:
    redis_data:
